<div class="container">
  <div class="column-container">
    <div class="column details">
      <mat-card appearance="outlined" class="patient-details">
        <mat-card-header>
          <mat-card-title>{{ patient.fullname }}</mat-card-title>
          <mat-card-subtitle>Dr. {{ medic.fullname }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Email: </span>
            <span class="value">{{ patient.email }}</span>
          </p>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Age: </span>
            <span class="value">{{ patient.age }}</span>
          </p>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Gender: </span>
            <span class="value">
              <mat-icon *ngIf="patient.sex === 'f'" fontSet="fa-solid" fontIcon="fa-venus"></mat-icon>
              <mat-icon *ngIf="patient.sex === 'm'" fontSet="fa-solid" fontIcon="fa-mars"></mat-icon>
            </span>
          </p>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Address: </span>
            <span class="value">{{ patient.address }}</span>
          </p>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Phone: </span>
            <span class="value">{{ patient.phone }}</span>
          </p>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">CNP: </span>
            <span class="value">{{ patient.cnp }}</span>
          </p>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Created At: </span>
            <span class="value">{{ patient.createD_AT | date : "dd.MM.yyyy" }}</span>
          </p>
          <mat-divider></mat-divider>
        </mat-card-content>
      </mat-card>
    </div>
    <div class="column medical">
      <mat-card appearance="outlined" class="sensor-table">
        <mat-card-content>
          <div class="mat-elevation-z8 table-container">
            <mat-toolbar color="primary"> Sensor Readings </mat-toolbar>
            <table mat-table [dataSource]="dataSource" class="sensor-table">
              <!-- ID Column -->
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>ID</th>
                <td mat-cell *matCellDef="let data">{{ data.entrY_ID }}</td>
              </ng-container>

              <!-- Temperature Column -->
              <ng-container matColumnDef="temperatureAvg">
                <th mat-header-cell *matHeaderCellDef>Temperature Avg</th>
                <td mat-cell *matCellDef="let data">{{ data.temperatureAvg }}</td>
              </ng-container>

              <!-- heartAvg Column -->
              <ng-container matColumnDef="heartAvg">
                <th mat-header-cell *matHeaderCellDef>Heartbeat Avg</th>
                <td mat-cell *matCellDef="let data">{{ data.heartAvg }}</td>
              </ng-container>

              <!-- EKGAvg Column -->
              <ng-container matColumnDef="EKGAvg">
                <th mat-header-cell *matHeaderCellDef>EKG Avg</th>
                <td mat-cell *matCellDef="let data">{{ data.EKGAvg }}</td>
              </ng-container>

              <!-- CreatedAt Column -->
              <ng-container matColumnDef="createD_AT">
                <th mat-header-cell *matHeaderCellDef>Created At</th>
                <td mat-cell *matCellDef="let data">
                  {{ data.createD_AT | date : "dd.MM.yyyy - HH:mm:ss" }}
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let data">
                  <button mat-icon-button (click)="showSensorData(data)">
                    <mat-icon fontSet="fa-solid" fontIcon="fa-eye" color="primary"></mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns" [class]="selectedSession.entrY_ID === row.entrY_ID ? 'selected' : ''"></tr>

              <!-- Row shown when there is no matching data. -->
              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" colspan="4">No data found</td>
              </tr>
            </table>
            <mat-paginator [pageSizeOptions]="[5, 10]" aria-label="Select page of data"></mat-paginator>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <mat-toolbar *ngIf="!selectedSession" color="warn"> No Data for graphs </mat-toolbar>
  <div class="column-container" *ngIf="!graphsError">
    <div class="column graphs">
      <mat-card appearance="outlined" class="sensor-table">
        <mat-card-header>
          <mat-card-title>Graphs</mat-card-title>
        </mat-card-header>
        <mat-card-content class="charts">
          <div class="chart-container">
            <canvas id="ekgChart">{{ ekgChart }}</canvas>
          </div>
          <div class="chart-container">
            <canvas id="tempChart">{{ tempChart }}</canvas>
          </div>
          <div class="chart-container">
            <canvas id="pulseChart">{{ pulseChart }}</canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <mat-toolbar *ngIf="!medicalHistory.length" color="warn"> No Medical History Data </mat-toolbar>
  <mat-toolbar *ngIf="medicalHistory.length" color="primary"> History Data </mat-toolbar>
  <div *ngIf="medicalHistory.length" class="column-container medical-history">
    <div *ngFor="let history of medicalHistory" class="column">
      <mat-card appearance="outlined" class="medical-history">
        <mat-card-header>
          <mat-card-title>Entry no. {{ history.id }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Hospital: </span>
            <span class="value">{{ history.hospital }}</span>
          </p>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Intervention: </span>
            <span class="value">{{ history.intervention }}</span>
          </p>
          <mat-divider></mat-divider>
          <p class="row">
            <span class="label">Intervention Date: </span>
            <span class="value">{{ history.interventioN_DATE | date : "dd.MM.yyyy - HH:mm:ss" }}</span>
          </p>
          <mat-divider></mat-divider>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <div class="column-container comments">
    <div class="column">
      <mat-card appearance="outlined" class="comments">
        <mat-card-header>
          <mat-card-title>Comments</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="comments-container" *ngIf="comments.length">
            <div *ngFor="let comment of comments">
              <mat-divider></mat-divider>
              <p class="row">
                <span class="label">{{ comment.createD_AT | date : "dd.MM.yyyy - HH:mm:ss" }}: </span>
                <span class="value"> {{ comment.comment }}</span>
              </p>
              <mat-divider></mat-divider>
            </div>
          </div>
          <form (ngSubmit)="addNewComment()">
            <mat-form-field class="full-width">
              <mat-label>Leave a comment</mat-label>
              <textarea name="comment" [(ngModel)]="newComment" matInput placeholder="Ex. It makes me feel..."></textarea>
            </mat-form-field>
            <button mat-raised-button color="primary">
              <span *ngIf="loadingComment" class="spinner-border spinner-border-sm me-1"></span>
              Send
            </button>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<div *ngIf="!loaded" class="loader-hack">
  <mat-spinner class="main-spinner"></mat-spinner>
</div>
